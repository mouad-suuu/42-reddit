generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  schemas  = ["public"]
}

/// User role for access control.
enum UserRole {
  USER
  ADMIN

  @@schema("public")
}

/// 42 Reddit application user, linked conceptually to 42 accounts.
model User {
  id          String   @id @default(cuid())
  intraId     Int?     @unique
  intraLogin  String   @unique
  displayName String?
  avatarUrl   String?
  campus      String?  // 42 campus identifier (slug/name)
  role        UserRole @default(USER)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  posts       Post[]
  comments    Comment[]
  votes       Vote[]

  @@schema("public")
}

/// 42 project tracked by the app (one row per 42 project).
model Project {
  id                String          @id @default(cuid())
  slug              String          @unique
  title             String
  fortyTwoProjectId Int?            @unique // ID from the 42 API
  category          ProjectCategory @default(OTHER)
  circle            Int             @default(-1) // -1 = unassigned, 0-6 = common core circles, 13 = no circle

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  posts             Post[]
  comments          Comment[]

  @@index([category])
  @@index([circle])
  @@schema("public")
}

/// Category of a 42 project (curriculum track).
enum ProjectCategory {
  NEW_CORE  // New common core (42cursus)
  OLD_CORE  // Old common core (legacy)
  PISCINE   // C Piscine projects
  OTHER     // Outer circle, specializations, etc.

  @@schema("public")
}

/// Post attached to a project: either a short comment or a README (markdown).
model Post {
  id        String    @id @default(cuid())

  project   Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId  String

  type      PostType
  title     String?   // Mainly used for README posts
  content   String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  comments  Comment[]
  votes     Vote[]

  @@unique([authorId, projectId, type]) // One README per user per project
  @@index([projectId])
  @@index([authorId, projectId, type])
  @@schema("public")
}

/// Comment tree for both project-level and post-level discussions.
model Comment {
  id              String    @id @default(cuid())

  // Either attached directly to a project, or to a specific post (or both).
  project         Project?  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId       String?

  post            Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId          String?

  author          User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId        String

  parent          Comment?  @relation("CommentToComment", fields: [parentCommentId], references: [id], onDelete: Cascade)
  parentCommentId String?
  replies         Comment[] @relation("CommentToComment")

  content         String
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  votes           Vote[]

  @@index([projectId])
  @@index([postId])
  @@index([parentCommentId])
  @@schema("public")
}

/// Upvote/downvote on posts or comments.
model Vote {
  id         String         @id @default(cuid())

  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String

  post       Post?          @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId     String?

  comment    Comment?       @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId  String?

  targetType VoteTargetType
  value      Int            // +1 or -1

  createdAt  DateTime       @default(now())

  @@unique([userId, postId])    // One vote per user per post
  @@unique([userId, commentId]) // One vote per user per comment
  @@index([userId])
  @@index([postId])
  @@index([commentId])
  @@schema("public")
}

/// Type of post content.
enum PostType {
  COMMENT
  README

  @@schema("public")
}

/// What kind of entity a vote targets.
enum VoteTargetType {
  POST
  COMMENT

  @@schema("public")
}
